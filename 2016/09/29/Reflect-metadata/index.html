<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      Reflect-metadata | AEPKILL 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="AEPKILL">
    
    

    <meta name="description" content="Reflect-metadata库提供了反射机制，通过这个库可以在记录一些元数据，并在运行时获取。">
<meta property="og:type" content="article">
<meta property="og:title" content="Reflect-metadata | AEPKILL">
<meta property="og:url" content="http://blog.aepkill.com/2016/09/29/Reflect-metadata/index.html">
<meta property="og:site_name" content="AEPKILL">
<meta property="og:description" content="Reflect-metadata库提供了反射机制，通过这个库可以在记录一些元数据，并在运行时获取。">
<meta property="og:updated_time" content="2016-09-28T06:21:38.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reflect-metadata | AEPKILL">
<meta name="twitter:description" content="Reflect-metadata库提供了反射机制，通过这个库可以在记录一些元数据，并在运行时获取。">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>
    <div id="about">
        <div class="card">
            <div class="close"></div>
            <div class="bd-user-head">
              <img src="/images/header.png" class="bd-user-headimg">
              <a class="bd-user-imgDescribe"><span>Yeah.</span></a>
            </div>
            <h2>AEPKILL</h2>
            <h4>
                只是喜欢惹人生气，我的态度依然强硬。
            </h4>
            <div class="contact">
              <a href="https://github.com/aepkill" title="aepkill on GitHub">
                <i class="icon icon-social-github"></i>
              </a>
              <a href="#" title="NULL">
                <i class="icon icon-social-500px"></i>
              </a>
              <a href="#" title="NULL">
                <i class="icon icon-social-google-plus"></i>
              </a>
            </div>
        </div>
    </div>
    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">AEPKILL</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          你怀疑生活洗刷你的灵感，可你又拖到明晚
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="aepkill-about-button">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archives" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">Reflect-metadata</h1>

    

    <div class="post-meta">
      <time datetime="2016-09-29" class="post-meta__date date">2016-09-29</time> 

      <span class="post-meta__tags tags">

          
            <font class="categories">
            &#8226; 分类:
            <a class="categories-link" href="/categories/笔记/">笔记</a>
            </font>
          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/typescript/">typescript</a>, <a class="tags-link" href="/tags/笔记/">笔记</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>Reflect-metadata库提供了反射机制，通过这个库可以在记录一些元数据，并在运行时获取。</p>
<p>反射机制是 TS 提供的一个特色功能， 此功能在 ES6 , ES7 提案中并未涉及。</p>
<p>通俗来讲，反射机制即是编译器在编译过程中将一些数据附着进代码中，代码真正运行时可以获取到这些 <strong>元数据</strong> ，当然，我们也可以自己定义一些 <strong>元数据</strong> 。 </p>
<blockquote>
<p>注意：上面这段话仅适用于 TS 的反射机制，可能于 C# , Java 等的反射机制有出入。</p>
</blockquote>
<h1 id="安装使用-Reflect-metadata"><a href="#安装使用-Reflect-metadata" class="headerlink" title="安装使用 Reflect-metadata"></a>安装使用 Reflect-metadata</h1><p><code>npm insall Reflect-metadata --save</code></p>
<p>然后再你的代码中 <code>import Reflect-metadata</code> ，然后你就可以使用 Reflect-metadata 了。</p>
<blockquote>
<p>Reflect-metadata 是一个 <code>有副作用</code> 的模块，它并没有导出任何函数，而是在全局空间上创建了 Reflect 这个命名空间</p>
</blockquote>
<h1 id="定义元数据"><a href="#定义元数据" class="headerlink" title="定义元数据"></a>定义元数据</h1><p>定义元数据我们可以使用 <code>React.defineMetadata</code> 这个函数，这个函数被重载过：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineMetadata</span>(<span class="params">metadataKey: <span class="built_in">any</span>, metadataValue: <span class="built_in">any</span>, target: <span class="built_in">Object</span></span>): <span class="title">void</span></span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineMetadata</span>(<span class="params">metadataKey: <span class="built_in">any</span>, metadataValue: <span class="built_in">any</span>, target: <span class="built_in">Object</span>, targetKey: <span class="built_in">string</span> | symbol</span>): <span class="title">void</span></span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineMetadata</span>(<span class="params">metadataKey: <span class="built_in">any</span>, metadataValue: <span class="built_in">any</span>, target: <span class="built_in">Object</span>, targetKey?: <span class="built_in">string</span> | symbol</span>): <span class="title">void</span></span>;</div></pre></td></tr></table></figure>
<p>target 代码元数据附着的目标，可以是一个对象或function。</p>
<p>targetKey 可以是一个 Symbol 或 String ，可选参数，指定将元数据关联在一个对象或function的某个字段上。</p>
<p>metadataValue 元数据的值</p>
<p>metadataKey 元数据的键</p>
<p>我们尝试给AEPKILL类的Say方法附加一点元数据:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">'Reflect-metadata'</span>;</div><div class="line"><span class="keyword">class</span> AEPKILL &#123;</div><div class="line">  <span class="keyword">public</span> Say()&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'cool'</span>)</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">Reflect.defineMetadata( <span class="string">'name'</span> , <span class="string">'aepkill'</span> , AEPKILL.prototype , <span class="string">'Say'</span> );</div></pre></td></tr></table></figure>
<p>很简单的一个函数，这里先不讲元数据有何用处，只是直观的感受下元数据该如何定义，通过 <code>Decorator</code> 还有一个简便的写法：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">'Reflect-metadata'</span>;</div><div class="line"><span class="keyword">class</span> AEPKILL &#123;</div><div class="line">  @Reflect.metadata( <span class="string">'name'</span> , <span class="string">'aepkill'</span> )</div><div class="line">  <span class="keyword">public</span> Say()&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'cool'</span>)</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>Reflect.metadata</code> 是一个装饰器工厂，他返回了一个附加元数据的装饰器，本质上来讲，这段代码和上面那段代码并没有任何差异，但是更简洁清晰明了。</p>
<h1 id="获取元数据"><a href="#获取元数据" class="headerlink" title="获取元数据"></a>获取元数据</h1><p>获取元数据我们可以使用 <code>React.getMetadata</code> 这个函数，这个函数也被重载过：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMetadata</span>(<span class="params">metadataKey: <span class="built_in">any</span>, target: <span class="built_in">Object</span></span>): <span class="title">any</span></span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMetadata</span>(<span class="params">metadataKey: <span class="built_in">any</span>, target: <span class="built_in">Object</span>, targetKey: <span class="built_in">string</span> | symbol</span>): <span class="title">any</span></span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMetadata</span>(<span class="params">metadataKey: <span class="built_in">any</span>, target: <span class="built_in">Object</span>, targetKey?: <span class="built_in">string</span> | symbol</span>): <span class="title">any</span></span>;</div></pre></td></tr></table></figure>
<p>参数含义和定义元数据一致，只是作用从定义变为了获取。</p>
<p>接上文代码，获取上面定义的<code>name</code> 元数据：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">....</div><div class="line"><span class="built_in">console</span>.log(Reflect.getMetadata( <span class="string">'name'</span> ,  AEPKILL.prototype , <span class="string">'Say'</span>)); <span class="comment">//=&gt; aepkill</span></div></pre></td></tr></table></figure>
<h1 id="元数据作用"><a href="#元数据作用" class="headerlink" title="元数据作用"></a>元数据作用</h1><p>从上文可以看出其实定义及获取一个元数据还是很简单的一件些事情，但这又有什么用呢？</p>
<h2 id="运行时参数检查"><a href="#运行时参数检查" class="headerlink" title="运行时参数检查"></a>运行时参数检查</h2><blockquote>
<p>TS的类型检查仅在编译时执行，而在运行过程中则是完全的 Javascript 代码，是不存在类型检查的，我们可以通过 <code>Decorator</code> + <code>元数据</code> 做到这一点。</p>
</blockquote>
<p>通过指定 <code>tsconfig.json</code> 的  <code>compilerOptions</code>字段中的 <code>emitDecoratorMetadata</code> 为 true，可以使编译器将一些编译时的信息附加到元数据，这些编译时的信息包括：</p>
<ol>
<li>参数类型 [仅方法] ， metadataKey 为 <code>design:paramtypes</code></li>
<li>方法返回值[仅方法]，metadataKey 为 <code>design:returntype</code></li>
<li>字段类型 ， metadataKey 为 <code>design:type</code></li>
</ol>
<p>可以看到，编译器将参数类型附加到了元数据，我们只要在运行时获取到并检查一下就可以达到运行时的类型检查了。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">'Refelct-metadata'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 定义装饰器</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ParamsCheck</span>(<span class="params">target: <span class="built_in">any</span>, propertyKey: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) </span>&#123;</div><div class="line">  	<span class="comment">// 获取字段类型信息</span></div><div class="line">    <span class="keyword">let</span> propertyType = Reflect.getMetadata(<span class="string">'design:type'</span>);</div><div class="line">  	<span class="comment">// 如果字段是一个方法则进行参数检查</span></div><div class="line">  	<span class="keyword">if</span> ( <span class="keyword">typeof</span> propertyType === <span class="string">'function'</span> &amp;&amp; descriptor) &#123;</div><div class="line">      <span class="comment">// 获取参数类型数组</span></div><div class="line">      <span class="keyword">let</span> argTypes: <span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt; = Reflect.getMetadata(<span class="string">'design:paramtypes'</span>, target, propertyKey);</div><div class="line">      <span class="comment">// 获取原来的方法实体</span></div><div class="line">      <span class="keyword">let</span> value = descriptor.value;</div><div class="line">      <span class="comment">// 替换原来的方法，增加检查参数类型检查，合法则调用原来的方法</span></div><div class="line">      descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params">...args: <span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt;</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (args.length !== argTypes.length) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'参数数量不匹配'</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</div><div class="line">          	<span class="comment">// 检查参数类型</span></div><div class="line">            <span class="keyword">if</span> (!(args[i] <span class="keyword">instanceof</span> argTypes[i]) &amp;&amp; !(args[i].constructor === argTypes[i])) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">`参数 <span class="subst">$&#123;i&#125;</span> 类型不匹配`</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        value.apply(<span class="keyword">this</span>, args);</div><div class="line">      &#125;</div><div class="line">  	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">class</span> AEPKILL &#123;</div><div class="line">  @ParamsCheck</div><div class="line">  <span class="keyword">public</span> say(name: <span class="built_in">string</span>)&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Hello , <span class="subst">$&#123;name&#125;</span>`</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> aep = <span class="keyword">new</span> AEPKILL();</div><div class="line">aep.say(<span class="string">'Jack'</span>); <span class="comment">// =&gt; Hello , Jack</span></div><div class="line">aep.say(<span class="number">1000</span> as <span class="built_in">any</span>); <span class="comment">// Error( '参数 0 类型不匹配' );</span></div></pre></td></tr></table></figure>
<h1 id="Reflect-metadata-原理"><a href="#Reflect-metadata-原理" class="headerlink" title="Reflect-metadata 原理"></a>Reflect-metadata 原理</h1><p>Reflect-metadata 原理非常简单，源码也只有1000来行，还有一大半是Polyfill 及 申明，真正的功能代码不足500行。</p>
<p>Reflect-metadata 创建了一个 WeakMap 对象 ， 暂且称作为 weakmap。</p>
<blockquote>
<p>WeakMap 是一个仅已对象为键值任意的特殊 Map ， 而且他对键对象保持弱引用，也就是说他的键不影响回收机制。了解更多:<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap" target="_blank" rel="external">WeakMap详细资料</a></p>
</blockquote>
<p>当你使用 <code>defineMetadata( metadataKey , metadataValue , target , targetKey )</code> 的时候， Reflect-metadata 执行了如下操作(流程说明，非真实源代码)：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> targetMetadata = weakmap.get(target);</div><div class="line"><span class="keyword">if</span> ( isUndefined( targetMetadata ) ) &#123;</div><div class="line">  weakmap.set(target , targetMetadata = <span class="keyword">new</span> Map());</div><div class="line">&#125;</div><div class="line"><span class="keyword">let</span> keyMetadata = targetMetadata.get( targetKey );</div><div class="line"><span class="keyword">if</span> (isUndefined( keyMetadata )) &#123;</div><div class="line">  targetMetadata.set( targetKey ,  keyMetadata = <span class="keyword">new</span> Map());</div><div class="line">&#125;</div><div class="line">keyMetadata.set( metadataKey , metadataValue );</div></pre></td></tr></table></figure>
<p>十分简单的原理，没有什么秘密可言。</p>

  </section>

  
  

<section class="post-comments">

    <div class="ds-thread" data-thread-key="2016/09/29/Reflect-metadata/"></div>

    <script type="text/javascript">
      var duoshuoQuery = {short_name:"AEPKILL"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
    </script> 

</section>


</article>


            <footer class="footer">
    <span class="footer__copyright">&copy; 2014-2015. | <a href="https://blog.aepkill.com/">blog.aepkill.com</a> | Power By: Hexo </span>
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
